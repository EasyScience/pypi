# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-python-with-github-actions

name: Python libs

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:

  get_Latest:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout ILL repo 
      run: |
        git clone https://code.ill.fr/scientific-software/crysfml/ ./
        git checkout feature-python_api-build_wheels
    - uses: actions/upload-artifact@v2
      with:
        name: CrysFML_SRC
        path: ${{ github.workspace }}/dist/*.whl    
        

  create-Linux:
    runs-on: ubuntu-latest
    
    needs: get_Latest
    
    steps:
    - uses: actions/download-artifact@v2
      with:
        name: CrysFML_SRC
        
    - name: Build manylinux wheels
      run:  docker run -e PLAT=manylinux2010_x86_64 -v `pwd`:/io quay.io/pypa/manylinux2010_x86_64 /io/Scripts/buildscript.sh

    - uses: actions/upload-artifact@v2
      with:
        name: CrysFML - Linux
        path: ${{ github.workspace }}/dist/*.whl

  create-OSX:
    strategy:
      max-parallel: 4
      matrix:
        python-version: ['3.6', '3.7', '3.8', '3.9']
        os: [macos-10.15]
        gcc_v: [ 10 ] # Version of GFortran we want to use.

    runs-on: ${{ matrix.os }}
      
    needs: get_Latest
    
    steps:
    - uses: actions/download-artifact@v2
      with:
        name: CrysFML_SRC
        
    - name: Setup python
      uses: actions/setup-python@v1
      with:
        python-version: ${{matrix.python-version}}

    - name: Install cmake
      run: pip3 install cmake delocate wheel

    - name: Build CFML (OSX)
      env:
        FC: gfortran-${{ matrix.gcc_v }}
        CC: gcc-${{ matrix.gcc_v }}
      run: |
        pip3 wheel ./ --no-deps -w ./old/
        delocate-wheel -w dist -v ./old/*.whl

    - uses: actions/upload-artifact@v2
      with:
        name: CrysFML - ${{ matrix.os }} - Python ${{ matrix.python-version }}
        path: ./dist/*.whl
